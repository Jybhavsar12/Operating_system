name: Build SimpleOS

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build OS Image
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y nasm qemu-system-x86 build-essential wget

    - name: Setup i686-elf cross-compiler
      run: |
        # Download and install pre-built cross-compiler
        cd /tmp
        wget https://newos.org/toolchains/i686-elf-4.9.1-Linux-x86_64.tar.xz
        sudo tar -xf i686-elf-4.9.1-Linux-x86_64.tar.xz -C /usr/local
        echo "/usr/local/cross/bin" >> $GITHUB_PATH
        
    - name: Verify toolchain
      run: |
        nasm -v
        i686-elf-gcc --version
        i686-elf-ld --version
        qemu-system-i386 --version
        
    - name: Build bootloader
      run: make bootloader
      
    - name: Build kernel
      run: make kernel
      
    - name: Build OS image
      run: make all
      
    - name: Verify build artifacts
      run: |
        ls -lh build/
        file build/boot.bin
        file build/kernel.bin
        file build/os-image.bin
        
    - name: Check OS image size
      run: |
        SIZE=$(stat -c%s build/os-image.bin)
        echo "OS image size: $SIZE bytes"
        if [ $SIZE -lt 512 ]; then
          echo "Error: OS image is too small!"
          exit 1
        fi
        if [ $SIZE -gt 10485760 ]; then
          echo "Warning: OS image is larger than 10MB"
        fi
        
    - name: Upload OS image artifact
      uses: actions/upload-artifact@v4
      with:
        name: os-image
        path: build/os-image.bin
        retention-days: 30
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          build/boot.bin
          build/kernel.bin
          build/**/*.o
        retention-days: 7

  test:
    name: Test OS Boot
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install QEMU
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-system-x86
        
    - name: Download OS image
      uses: actions/download-artifact@v4
      with:
        name: os-image
        path: build/
        
    - name: Test boot in QEMU (headless)
      timeout-minutes: 1
      run: |
        # Run QEMU in headless mode for 5 seconds
        timeout 5s qemu-system-i386 \
          -drive format=raw,file=build/os-image.bin \
          -display none \
          -serial stdio \
          -no-reboot \
          || true
        echo "Boot test completed"
        
    - name: Test boot with serial output
      timeout-minutes: 1
      run: |
        # Capture serial output
        timeout 5s qemu-system-i386 \
          -drive format=raw,file=build/os-image.bin \
          -display none \
          -serial file:boot.log \
          -no-reboot \
          || true
        
        if [ -f boot.log ]; then
          echo "=== Boot Log ==="
          cat boot.log
          echo "================"
        fi

  lint:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check file permissions
      run: |
        find . -type f -name "*.c" -executable -exec echo "Warning: {} is executable" \;
        find . -type f -name "*.h" -executable -exec echo "Warning: {} is executable" \;
        
    - name: Check for trailing whitespace
      run: |
        ! git grep -I --line-number '\s$' -- '*.c' '*.h' '*.asm' || \
        echo "Warning: Found trailing whitespace"
        
    - name: Verify documentation exists
      run: |
        test -f README.md || (echo "Missing README.md" && exit 1)
        test -f LICENSE || (echo "Missing LICENSE" && exit 1)
        test -f docs/BUILDING.md || (echo "Missing BUILDING.md" && exit 1)
        test -f docs/ARCHITECTURE.md || (echo "Missing ARCHITECTURE.md" && exit 1)
        echo "All required documentation files present"

